name: Release application

on:
    push:
        branches:
            - main

jobs:
    build-publish-deploy:
        name: Build, Publish and Deploy
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - uses: google-github-actions/auth@v2
              with:
                  credentials_json: "${{ secrets.GKE_SA_KEY }}"

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Use gcloud CLI
              run: gcloud info

            - name: Get GKE credentials
              uses: "google-github-actions/get-gke-credentials@v2"
              with:
                  cluster_name: "${{ env.GKE_CLUSTER }}"
                  project_id: "${{ env.PROJECT_ID }}"
                  location: "${{ env.GKE_ZONE }}"

            - name: Build
              run: docker build --tag $IMAGE_TAG .

            - name: Publish
              run: docker push $IMAGE_TAG

            - name: Set up Kustomize
              uses: imranismail/setup-kustomize@v2.1.0

            - name: Deploy
              run: |-
                  kustomize edit set image PROJECT/IMAGE=$IMAGE_TAG
                  kustomize build . | kubectl apply -f -
                  kubectl rollout status deployment $SERVICE
                  kubectl get services -o wide

        env:
            PROJECT_ID: ${{ secrets.PROJECT_ID }}
            GKE_CLUSTER: dwk-cluster
            GKE_ZONE: europe-north1-b
            REGISTRY: europe-north1-docker.pkg.dev
            REPOSITORY: my-repository
            IMAGE: dwk-environments
            SERVICE: dwk-environments
            BRANCH: ${{ github.ref_name }}

    build-publish-deploy-project:
        name: Build, Publish and Deploy Project
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - uses: google-github-actions/auth@v2
              with:
                  credentials_json: "${{ secrets.GKE_SA_KEY }}"

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Configure Docker for GCR
              run: gcloud auth configure-docker gcr.io

            - name: Get GKE credentials
              uses: "google-github-actions/get-gke-credentials@v2"
              with:
                  cluster_name: "${{ env.GKE_CLUSTER }}"
                  project_id: "${{ env.PROJECT_ID }}"
                  location: "${{ env.GKE_ZONE }}"

            - name: Build
              working-directory: ./the_project
              run: docker build --tag $PROJECT_IMAGE_TAG .

            - name: Publish
              run: docker push $PROJECT_IMAGE_TAG

            - name: Set up Kustomize
              uses: imranismail/setup-kustomize@v2.1.0

            - name: Deploy
              working-directory: ./the_project/manifests
              run: |-
                  kubectl apply -k .
                  kubectl rollout status deployment/todo-server-dep -n project
                  kubectl get services -n project -o wide

        env:
            PROJECT_ID: ${{ secrets.PROJECT_ID }}
            GKE_CLUSTER: dwk-cluster
            GKE_ZONE: europe-north1-b
            PROJECT_IMAGE_TAG: gcr.io/${{ secrets.PROJECT_ID }}/todo-server:latest
            BRANCH: ${{ github.ref_name }}
