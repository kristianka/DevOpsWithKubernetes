name: Release application

on:
    push:
        branches:
            - main
        paths:
            - "the_project/**"
            - ".github/workflows/main.yaml"

env:
    PROJECT_ID: ${{ secrets.PROJECT_ID }}
    GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
    GKE_ZONE: ${{ secrets.GKE_ZONE }}
    IMAGE: todo-server
    NAMESPACE: project

jobs:
    build-publish-deploy:
        name: Build, Publish and Deploy to GKE
        runs-on: ubuntu-latest
        environment: deploy

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Validate secrets
              run: |
                  if [ -z "${{ secrets.GKE_SA_KEY }}" ]; then
                    echo "::error::Secret GKE_SA_KEY is not set. Please configure it in GitHub repository settings."
                    exit 1
                  fi
                  if [ -z "${{ secrets.PROJECT_ID }}" ]; then
                    echo "::error::Secret PROJECT_ID is not set. Please configure it in GitHub repository settings."
                    exit 1
                  fi

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Authenticate to Google Cloud
              id: auth
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GKE_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Configure Docker for GCR
              run: gcloud auth configure-docker gcr.io --quiet

            - name: Get GKE credentials
              uses: google-github-actions/get-gke-credentials@v2
              with:
                  cluster_name: ${{ env.GKE_CLUSTER }}
                  project_id: ${{ env.PROJECT_ID }}
                  location: ${{ env.GKE_ZONE }}

            - name: Generate image metadata
              id: meta
              run: |
                  IMAGE_TAG="gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE }}:${{ github.sha }}"
                  echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
                  echo "Image tag: $IMAGE_TAG"

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: ./the_project
                  push: true
                  tags: |
                      gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE }}:${{ github.sha }}
                      gcr.io/${{ env.PROJECT_ID }}/${{ env.IMAGE }}:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Set up Kustomize
              uses: imranismail/setup-kustomize@v2.1.0

            - name: Deploy to GKE
              working-directory: ./the_project/manifests
              run: |
                  # Update image tag in kustomization
                  kustomize edit set image gcr.io/PROJECT_ID/${{ env.IMAGE }}=${{ steps.meta.outputs.image_tag }}

                  # Apply all resources
                  kustomize build . | kubectl apply -f -

                  # Wait for deployment rollout (Recreate strategy due to ReadWriteOnce PVC)
                  kubectl rollout status deployment/todo-server-dep -n ${{ env.NAMESPACE }} --timeout=300s

                  # Show deployment status
                  echo "=== Deployment Status ==="
                  kubectl get deployments -n ${{ env.NAMESPACE }}
                  echo "=== Pods ==="
                  kubectl get pods -n ${{ env.NAMESPACE }}
                  echo "=== Services ==="
                  kubectl get services -n ${{ env.NAMESPACE }} -o wide
